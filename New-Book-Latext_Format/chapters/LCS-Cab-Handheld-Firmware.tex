\chapter{Cab Handheld Firmware}

Now that the development platform is in place, lets have a look at the firmware design. As you perhaps have guessed it, the hardware was already developed with a certain mode in mind. First of all, a cab handheld is nothing else than just another node on the LCS bus. The firmware sits on top of the LCS core library. In addition, there is another key library we have not talked about yet. A cab handheld and also any other device that allows for users to interact, needs software to work with buttons, encoders, displays and so on. This the tasks of the \textbf{UI Elements } library. We will look at this library in a later chapter in great detail.

// ??? note perhaps a picture ?
\begin{itemize}
\begin{itemize}
\item SW architecture on top of the LCS library
\item UI is key to build a handheld
\item firmware to handle the buttons, switches, display, etc. Refer to UIElements.
\item issues LCS messages to the base station for speed, direction and functions
\item menu descriptions
\end{itemize}
\end{itemize}

\section{Concepts}

\begin{itemize}
\begin{itemize}
\item a current cab and a stack of cabs to select from
\item base station has the ultimate data about a cab, loaded into the cab handheld
\item CabHandheld functions and DCC functions
\end{itemize}
\end{itemize}

\section{Screen Layout}

\begin{itemize}
\begin{itemize}
\item display has 4 lines up to 16 characters. Two fonts
\item four navigation buttons, use top and bottom line, 8x8 font
\item two data lines between, 8x16 font.
\end{itemize}
\end{itemize}

\section{Screen Navigation}

\begin{itemize}
\begin{itemize}
\item inherent in the UI Elements Screen Object design
\item MENU
\item SELECT
\item UP
\item DOWN
\end{itemize}
\end{itemize}

\section{Operate Screen}

\begin{itemize}
\begin{itemize}
\item main screen, workhorse
\item speed, dir, functions
\end{itemize}
\end{itemize}

\section{Engine On/off Screen}

\begin{itemize}
\begin{itemize}
\item for diesels only
\end{itemize}
\end{itemize}

\section{Engine Lights Screen}

\begin{itemize}
\begin{itemize}
\item front and back lights...
\end{itemize}
\end{itemize}

\section{New Cab Screen}

There needs to be a way to set an engine cab number. The NEW CAB screen is used to enter a cab Id and engine type. We will display 4 digits and the engine type among we can toggle with the MENU button. The UP/DOWN buttons advance the current digit position. The encoder knob offers a fast way to scroll a digit. The high value digit allows to set an "S" instead of the number to indicate a short loco DCC address. The SELECT button completes the number entering and the current cab becomes this new cab. Note, that it would need to be explicitly saved.
\begin{itemize}
\begin{itemize}
\item works on current cab setting
\end{itemize}
\end{itemize}

\section{Select Cab Screen}

A cab handheld maintains a stack of known cabs. That is cabs the handheld has used before and saved in the cab stack. This menu will toggle through them and select the new current cab. The UP/DOWN button is used to scroll around. In addition, the encoder knob allows to scroll a bit faster. The SELECT button will make the entry shown the current loco.
\begin{itemize}
\begin{itemize}
\item SELECT scrolls through the cab stack and sets the cab selected as current cab.
\end{itemize}
\end{itemize}

\section{Save Cab Screen}

The current cab can be saved in the cab stack. This menu will toggle through them and select the cab slot for saving the current cab data. The UP/DOWN button is used to scroll around. In addition, the encoder knob allows to scroll a bit faster. The SELECT button will perform the action.
\begin{itemize}
\begin{itemize}
\item SAVE scrolls through the cab stack and saves the current cab to this slot.
\item any previous entry used for the same cabId is cleared.
\end{itemize}
\end{itemize}

\section{Set DCC Function}

The DCC standard defines a list of 69 functions, F0 to F68.
\begin{itemize}
\begin{itemize}
\item allows to set any DCC function ( F0 to F68 )
\item encoder knob for fast scrolling
\end{itemize}
\end{itemize}

\section{Config Cab Handheld Functions}

\begin{itemize}
\begin{itemize}
\item connects a cab handheld function to a DCC function
\end{itemize}
\end{itemize}

\section{Options}

\begin{itemize}
\begin{itemize}
\item all kinds of screen for configuration settings
\end{itemize}
\end{itemize}

\section{Diag}

\begin{itemize}
\begin{itemize}
\item all kinds of screen for technical checks and tests
\end{itemize}
\end{itemize}

\section{Summary}

Phew. The cab handheld is another big step toward controlling a layout. After all, a layout control system without some form cab handhelds is not very useful. As said, there are many ways to build a cab.
\begin{itemize}
\begin{itemize}
\item design of UI elements and firmware was greatly influenced by a handheld called \textbf{\textit{Protothrottle}}.
\item The next chapter will present a diesel cab handheld that resembles a diesel cab stand from the 1950s.
\end{itemize}
\end{itemize}
